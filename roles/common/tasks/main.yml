---
- name: Get information about the cluster
  set_fact:
    api_groups: "{{ lookup('k8s', cluster_info='api_groups') }}"
  when:
  - not is_openshift | bool
  - not is_k8s | bool

- name: Determine the cluster type
  set_fact:
    is_openshift: "{{ True if 'route.openshift.io' in api_groups else False }}"
    is_k8s: "{{ False if 'route.openshift.io' in api_groups else True }}"
  when:
  - not is_openshift | bool
  - not is_k8s | bool

# Indicate what kind of cluster we are in (OpenShift or Kubernetes).
- debug:
    msg: "CLUSTER TYPE: is_openshift={{ is_openshift }}; is_k8s={{ is_k8s }}"

# tasks file for EDA

# get and set annotations passed via CR
- name: Look up details for this deployment
  k8s_info:
    api_version: "{{ api_version }}"
    kind: "{{ kind }}"
    name: "{{ ansible_operator_meta.name }}"
    namespace: "{{ ansible_operator_meta.namespace }}"
  register: this_eda

- name: set annotations based on this_eda
  set_fact:
    this_annotations: "{{ this_eda['resources'][0]['metadata']['annotations'] | default({}) }}"

- name: set client_request_timeout based on annotation
  set_fact:
    client_request_timeout: "{{ (this_annotations['aap.ansible.io/client-request-timeout'][:-1]) | int }}"
    client_request_timeout_overidden: true
  when:
    - "'aap.ansible.io/client-request-timeout' in this_annotations"
    - this_annotations['aap.ansible.io/client-request-timeout'] is match('^\\d+s$')

- name: client_request_timeout has been changed
  debug:
    msg: "client_request_timeout's default 30s value has been overriden by the annotation 'aap.ansible.io/client-request-timeout' to {{ client_request_timeout }}s"
  when: client_request_timeout_overidden | default(false)

- name: Create EDA ServiceAccount
  k8s:
    apply: yes
    definition: "{{ lookup('template', item + '.yaml.j2') }}"
  loop:
    - 'service_account'
  no_log: "{{ no_log }}"

- name: Patch Labels
  include_tasks: patch_labels.yml
