apiVersion: v1
kind: ConfigMap
metadata:
  name: '{{ ansible_operator_meta.name }}-nginx-api-configmap'
  namespace: '{{ ansible_operator_meta.namespace }}'
data:
  nginx_api_default_conf_template: |
    events {
        worker_connections 1024;
    }
    http {
        map $http_x_forwarded_proto $remote_scheme {
            default $http_x_forwarded_proto;
            ''      $scheme;
        }

        include mime.types;
        types {
            application/manifest+json webmanifest;
        }
        server {
            listen {{ api_nginx_port }};
            location ^~ /static/ {
                alias {{ static_path }}/;
                access_log /var/log/nginx/static_access.log;
                error_log /var/log/nginx/static_error.log;
            }
            location / {
                proxy_pass http://127.0.0.1:{{ api_django_port }};  # Forward requests to Django app
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                access_log /var/log/nginx/proxy_access.log;
                error_log /var/log/nginx/proxy_error.log;
            }
            # Redirect trailing slash for eda root
            location = /api/eda {
                return 301 $scheme://$host/api/eda/;
            }
        }
    }
